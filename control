<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Control General | Legends</title>
  <meta name="description" content="Control general de inscripciones por club">
  <link rel="icon" type="image/png" href="https://i.ibb.co/nN8LPTjD/logo-verde.png" />
  <meta name="theme-color" content="#084D1F">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: "Montserrat", sans-serif; 
      background: #F5F6F2; 
      color: #084D1F; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      width: 100%; 
      padding: 0 5px; 
    }
    h1,h2,h3,h4 { text-align: center; margin: 5px 0; }

    .portada { 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      width: 100%; 
      margin: 0 auto; 
      padding: 10px 0; 
    }
    .portada img { max-width: 100%; height: auto; display: block; border-radius: 0 0 12px 12px; }

    #loader { 
      position: fixed; 
      top: 0; left: 0; 
      width: 100%; 
      height: 100%; 
      background: #084D1F; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      flex-direction: column; 
      z-index: 9999; 
    }
    #loader img { width: 120px; height: auto; animation: pulse 1.5s infinite ease-in-out; }
    #loader p { color: #F5F6F2; margin-top: 20px; font-size: 1.2rem; font-weight: 600; letter-spacing: 1px; text-align: center; }
    @keyframes pulse { 0%{transform:scale(1);opacity:1;} 50%{transform:scale(1.15);opacity:0.8;} 100%{transform:scale(1);opacity:1;} }
    .hidden { display: none !important; }

    #login { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center; 
      width: 100%; 
      max-width: 400px; 
      margin: 20px auto; 
      padding: 20px; 
      background: #fff; 
      border-radius: 8px; 
      box-shadow: 2px 2px 8px rgba(0,0,0,0.1); 
      text-align: center; 
    }
    #login input, #login button { 
      width: 100%; 
      margin: 5px 0; 
      padding: 12px; 
      border-radius: 6px; 
      border: 1px solid #084D1F; 
      font-size: 16px; 
      text-align: center; 
    }
    #login button { background: #084D1F; color: #F5F6F2; cursor: pointer; transition: background 0.2s; }
    #login button:hover { background: #0A702A; }

    #app { display: none; width: 100%; max-width: 900px; margin: 0 auto; text-align: center; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; min-width: 700px; }
    th, td { border: 1px solid #084D1F; padding: 6px; text-align: center; word-wrap: break-word; }
    th { background: #084D1F; color: #F5F6F2; }
    tr.fullyPaid { background: #c8e6c9; }

    button { 
      font-family: "Montserrat", sans-serif; 
      padding: 6px; 
      margin: 2px; 
      border-radius: 6px; 
      border: 1px solid #084D1F; 
      font-size: 14px; 
      background: #084D1F; 
      color: #F5F6F2; 
      cursor: pointer; 
      transition: background 0.2s; 
    }
    button:hover { background: #0A702A; }

    #totales { margin-top: 10px; font-weight: bold; text-align: center; }
    #felicitaciones { margin-top: 10px; color: #084D1F; font-weight: bold; text-align: center; }

    @media(max-width:768px){
      input, button{width:100%; font-size:14px; padding:10px;}
      table, th, td{font-size:13px; padding:5px;}
      #login, #app{padding:15px;}
      #loader img{width:100px;}
    }

    @media(max-width:480px){
      body{padding:0 5px;}
      table, th, td{font-size:12px; padding:4px;}
      #login, #app{padding:10px;}
      #loader img{width:80px;}
      button{font-size:12px; padding:5px;}
    }
  </style>
</head>
<body>

  <div id="loader">
    <img src="https://i.ibb.co/GfJfM48J/Tilcara-logo-con-sombra.png" alt="Escudo del Club">
  </div>

  <div class="portada">
    <img src="https://i.ibb.co/ym93ZMtF/Admin-Jugadores.png" alt="Encuentro Rugby Veteranos">
  </div>

  <div id="login">
    <h2>Login</h2>
    <input id="usuario" placeholder="Usuario">
    <input id="clave" type="password" placeholder="Clave">
    <button onclick="login()">Entrar</button>
  </div>

  <div id="app">
    <h2>Bienvenido <span id="rolText"></span></h2>
    <div id="totales"></div>
    <div id="felicitaciones"></div>
    <div style="width:100%; overflow-x:auto; margin-top:10px;">
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Club</th>
            <th>Nombre</th>
            <th>Apellido</th>
            <th>Edad</th>
            <th>CUIL/CUIT</th>
            <th>Tipo Entrada</th>
            <th>Invitados</th>
            <th>Total</th>
            <th>Abono</th>
            <th>Saldo</th>
            <th>AcciÃ³n</th>
          </tr>
        </thead>
        <tbody id="players"></tbody>
      </table>
    </div>
  </div>
<!-- <button onclick="downloadCSV()">ðŸ“¥ Descargar Listado</button>-->

  <script>
    const API_URL = '/.netlify/functions/gs-proxy';
    const loader = document.getElementById("loader");
    let clubesActuales = [];
    let modo = null;

    function showLoader(){ loader.classList.remove("hidden"); }
    function hideLoader(){ loader.classList.add("hidden"); }

    window.addEventListener("load", () => { 
      showLoader(); 
      setTimeout(()=>hideLoader(), 1200); 
    });

    async function login() {
      showLoader();
      const usuario = document.getElementById("usuario").value;
      const clave = document.getElementById("clave").value;
      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "login", usuario, clave })
        });
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } 
        catch(err) { 
          console.error("Respuesta no es JSON:", text); 
          alert("Error: el servidor no devolviÃ³ JSON vÃ¡lido"); 
          hideLoader(); 
          return; 
        }
        hideLoader();
        if (data.ok) {
          document.getElementById("rolText").innerText = usuario;
          document.getElementById("login").style.display = "none";
          document.getElementById("app").style.display = "block";
          clubesActuales = data.club.split(",").map(c => c.trim());
          modo = data.modo;
          loadPlayersMulti(clubesActuales);
        } else {
          alert("Usuario o clave incorrectos");
        }
      } catch (err) {
        hideLoader();
        alert("Error de conexiÃ³n");
        console.error(err);
      }
    }

    async function loadPlayersMulti(clubes){
      showLoader();
      let all = [];
      try {
        const promises = clubes.map(club => {
  console.log("Club consultado:", club);   // debug
  return fetch(API_URL,{
    method: "POST",
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({action:"getPlayers", club})
  }).then(r => r.json());
});

        const results = await Promise.all(promises);
        results.forEach(data => {
          if(data.ok) all = all.concat(data.players);
        });
        renderTable(all);
      } catch(err){ 
        alert("Error de red"); 
        console.error(err); 
      } finally{ hideLoader(); }
    }

    async function addPayment(cuil){
      const abonoInput = prompt("Ingrese nuevo Abono:");
      if(abonoInput === null) return;
      const abono = Number(abonoInput);
      if(isNaN(abono) || abono <= 0){ alert("Abono no vÃ¡lido"); return; }
      showLoader();
      try{
        const res = await fetch(API_URL,{
          method:"POST",
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({action:"addPayment", cuil, abono})
        });
        const data = await res.json();
        if(data.ok){ loadPlayersMulti(clubesActuales); } 
        else alert("Error: "+data.error);
      } catch(err){ alert("Error de red"); console.error(err); }
      finally{ hideLoader(); }
    }

    function formatCurrency(num){ return "$" + Number(num).toLocaleString('es-AR'); }

    function renderTable(players){
      const table = document.getElementById("players");
      table.innerHTML = "";
      let total=0, abonos=0, saldos=0;
      let jugadores=0, soloComida=0, invitados=0;

      players.forEach(p => {
        const totalNum = Number(p.Total)||0;
        const abonoNum = Number(p.Abono)||0;
        const saldoNum = Number(p.Saldo)||(totalNum-abonoNum);
        total += totalNum; abonos += abonoNum; saldos += saldoNum;

        if (p["Tipo Entrada"] && p["Tipo Entrada"].toLowerCase().includes("jugador")) jugadores++;
        else if (p["Tipo Entrada"] && p["Tipo Entrada"].toLowerCase().includes("comida")) soloComida++;

        invitados += Number(p.Invitados)||0;

        const tr = document.createElement("tr");
        if(saldoNum===0) tr.classList.add("fullyPaid");

        let botonAbono = `<button onclick="addPayment('${p["CUIL/CUIT"]}')">Agregar Abono</button>`;
        if(modo === "vista"){
          botonAbono = `<button onclick="alert('No tenÃ©s permiso para agregar abonos')">Agregar Abono</button>`;
        }

        tr.innerHTML = `
          <td>${p.Fecha||""}</td>
          <td>${p.Club||""}</td>
          <td>${p.Nombre||""}</td>
          <td>${p.Apellido||""}</td>
          <td>${p.Edad||""}</td>
          <td>${p["CUIL/CUIT"]||""}</td>
          <td>${p["Tipo Entrada"]||""}</td>
          <td>${p.Invitados||""}</td>
          <td>${formatCurrency(totalNum)}</td>
          <td>${formatCurrency(abonoNum)}</td>
          <td>${formatCurrency(saldoNum)}</td>
          <td>${botonAbono}</td>`;
        table.appendChild(tr);
      });

      document.getElementById("totales").innerText = 
        `Total: ${formatCurrency(total)} | Abonos: ${formatCurrency(abonos)} | Saldo: ${formatCurrency(saldos)}`;

      const resumen = `
        Jugadores: ${jugadores}  
        Solo Comida: ${soloComida}  
        Invitados: ${invitados}  
        Total Participantes: ${jugadores + soloComida + invitados}
      `;
      document.getElementById("felicitaciones").innerText = resumen;

      if (saldos===0) {
        document.getElementById("felicitaciones").innerText += "\nðŸŽ‰ Â¡Todos los jugadores ya estÃ¡n Abonados!";
      }
    }
  </script>

  <script>
    if (location.protocol !== 'https:') {
      location.replace(`https:${location.href.substring(location.protocol.length)}`);
    }
  </script>
<script>
function downloadCSV() {
  const rows = document.querySelectorAll("table tr");
  let csv = [];

  rows.forEach(row => {
    let cols = row.querySelectorAll("td, th");
    let data = [];
    cols.forEach(col => data.push('"' + col.innerText.replace(/"/g, '""') + '"'));
    csv.push(data.join(","));
  });

  let csvString = csv.join("\n");
  let blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });
  let link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "listado.csv";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
</script>

</body>
</html>
